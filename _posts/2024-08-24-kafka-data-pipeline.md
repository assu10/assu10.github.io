---
layout: post
title:  "Kafka - "
date: 2024-08-24
categories: dev
tags: kafka
---

이 포스트에서는 아래의 내용에 대해 알아본다.
- 데이터 파이프라인을 구축할 때 공통적으로 고려해야 할 문제들
- 카프카가 왜 데이터 통합에 적합하고, 어떻게 많은 문제들을 해결하는지?
- 카프카 커넥트 API 가 일반적인 프로듀서와 클라이언트와 어떻게 다른지, 언제 어떤 타입을 사용해야 하는지?
- 카프카 커넥트의 기초적인 사용 방법과 기본적인 사용 예제
- 다른 데이터 통합 시스템과 이것들을 어떻게 카프카와 연동할 수 있는지?

아파치 카프카를 사용한 데이터 파이프라인 구축의 활용 사례의 예는 아래와 같다.
- 아파치 카프카가 2개의 엔드포인트 중 하나가 되는 데이터 파이프라인
  - 카프카에서 가져온 데이터를 S3 에 넣거나 몽고 DB 의 데이터를 카프카로 가져오는 경우
- 2개의 서로 다른 시스템을 연결하는 파이프라인을 만들면서 그 중간에 카프카 사용
  - 트위터에서 카프카로 데이터를 전달한 후 다시 카프카에서 엘라스틱서치로 전달함으로써 트위터에서 가져온 데이터를 엘라스틱서치로 보내는 경우

데이터 파이프라인에 있어서 카프카가 갖는 주요한 역할은 데이터 파이프라인의 다양한 단계 사이사이에 있어 매우 크고 안정적인 버퍼 역할을 한다느느 것이다.  
이것은 데이터 파이프라인의 데이터를 쓰는 쪽과 읽는 쪽을 분리함으로써 하나의 원본에서 가져온 동일한 데이터를 서로 다른 적시성과 가용성 요구 조건을 가진 
여러 대상 애플리케이션이나 시스템으로 보낼 수 있게 한다.

데이터 파이프라인의 양쪽을 분리할 수 있다는 점은 신뢰성, 보안성, 효율성과 함께 카프카가 대부분의 데이터 파이프라인에 적합한 이유이다.

> 소스는 [github](https://github.com/assu10/kafka/tree/feature/chap09) 에 있습니다.

---

**목차**

<!-- TOC -->
* [1. 데이터 파이프라인 구축 시 고려사항](#1-데이터-파이프라인-구축-시-고려사항)
  * [1.1. 적시성(timeliness)](#11-적시성timeliness)
  * [1.2. 신뢰성](#12-신뢰성)
  * [1.3. 높으면서도 조정 가능한 처리율](#13-높으면서도-조정-가능한-처리율)
  * [1.4. 데이터 형식](#14-데이터-형식)
  * [1.5. 변환](#15-변환)
  * [1.6. 보안](#16-보안)
  * [1.7. 장애 처리](#17-장애-처리)
  * [1.8. 결합과 민첩성](#18-결합과-민첩성)
* [2. 카프카 커넥트 vs 프로듀서/컨슈머](#2-카프카-커넥트-vs-프로듀서컨슈머)
* [3. 카프카 커넥트](#3-카프카-커넥트)
  * [3.1. 카프카 커넥트 실행](#31-카프카-커넥트-실행)
  * [3.2. 커넥터 예시: 파일 소스와 파일 싱크](#32-커넥터-예시-파일-소스와-파일-싱크)
  * [3.3. 커넥터 예시: MySQL에서 Elasticsearch 로 데이터 전송](#33-커넥터-예시-mysql에서-elasticsearch-로-데이터-전송)
  * [3.4. 개별 메시지 변환](#34-개별-메시지-변환)
  * [3.5. 카프카 커넥트 좀 더 자세히](#35-카프카-커넥트-좀-더-자세히)
* [4. 카프카 커넥트 대안](#4-카프카-커넥트-대안)
  * [4.1. 다른 데이터 저장소를 위한 수집 프레임워크](#41-다른-데이터-저장소를-위한-수집-프레임워크)
  * [4.2. GUI 기반 ETL 툴](#42-gui-기반-etl-툴)
  * [4.3. 스트림 프로세싱 프레임워크](#43-스트림-프로세싱-프레임워크)
* [참고 사이트 & 함께 보면 좋은 사이트](#참고-사이트--함께-보면-좋은-사이트)
<!-- TOC -->

---

**개발 환경**

- mac os
- openjdk 17.0.12
- zookeeper 3.9.2
- apache kafka: 3.8.0 (스칼라 2.13.0 에서 실행되는 3.8.0 버전)

---

# 1. 데이터 파이프라인 구축 시 고려사항

다수의 시스템을 통합하고자 하는 목적으로 소프트웨어 아키텍처를 디자인할 때 고려해야 할 중요한 몇 가지에 대해 알아보자.

---

## 1.1. 적시성(timeliness)

하루에 한 번 대량의 데이터를 받아야 하는 시스템도 있고, 데이터가 생성되자마자 받아야 하는 시스템도 있다.  
좋은 데이터 통합 시스템은 각각의 데이터 파이프라인에 대해 서로 다른 적시성 요구 조건을 지원하면서도 업무에 대한 요구 조건이 변경되었을 때 이전하기가 쉽다.

쓰는 쪽에서는 필요에 따라 자주 혹은 가끔 카프카에 쓸 수 있고, 읽는 쪽 역시 최신 이벤트가 도착하는 즉시 혹은 배치 형태로 데이터를 읽어올 수 있다.  
매시간 실행되어서 카프카에 연결한 뒤 지난 시간동안 누적된 이벤트들을 읽어오는 식이다.

카프카를 쓰는 쪽과 읽는 쪽 사이의 시간적 민감도에 대한 요구 조건을 분리시키는 거대한 버퍼로 생각하면 이해하기 쉽다.  
쓰는 쪽에서는 실시간으로 쓸 수 있지만, 읽는 쪽에서는 배치 단위로 읽을 수 있고 그 반대도 가능하다.

이것은 백프레셔(back pressure) 적용 역시 단순하게 해준다.

> **백프레셔(back pressure)**
> 
> 소비자가 데이터를 처리하는 속도보다 생산자가 데이터를 생성하는 속도가 빠를 때 생기는 문제를 해결하기 위한 메커니즘  
> 생산자가 데이터를 소비자에게 전송하기 전에 소비자가 처리할 수 있는 양을 조절하는 방식

즉, 데이터의 소비 속도가 온전히 읽는 쪽에 의해 결정되기 때문에 카프카 자체에서 필요한 경우 쓰는 쪽에 대한 응답을 늦춤으로써 백프레셔를 적용하는 것이다.

---

## 1.2. 신뢰성

단일 장애점을 최대한 피하는 한편 모든 종류의 장애 발생에 대해 신속하고 자동화된 복구를 수행해야 한다.

데이터 파이프라인은 대부분의 경우 중요한 비즈니스 시스템에 데이터가 전달되는 통로이기도 하기 때문에 몇 초간의 장애가 발생하는 것만으로도 전체 시스템에 큰 지장을 줄 수 있다.  
특히 실시간에 가까운 **적시성**을 요구하는 시스템에서는 더욱 그렇다.

신뢰성에 대해 생각할 때 중요한 또 다른 고려 사항은 **전달 보장**이다.  
데이터 유실을 허용하는 시스템도 있지만, 대부분의 경우 **'최소 한 번'** 보장을 요구하는 것이 보통이기 때문에 원본 시스템에서 발생한 이벤트는 모두 목적지에 도착해야 한다.  
**'정확히 한 번'** 전달 보장을 요구하는 경우도 많다.  
즉, **원본 시스템에서 발생한 모든 이벤트가 이벤트 유실도 없고, 중복도 없이 목적지에 도착**해야 하는 것이다.

[Kafka - 신뢰성 있는 데이터 전달, 복제](https://assu10.github.io/dev/2024/08/17/kafka-reliability/) 에 카프카의 가용성과 신뢰성에 대해 나와있다.

카프카는 자체적으로 **'최소 한 번'** 전달을 보장하며, 트랜잭션 모델이나 고유 키를 지원하는 외부 데이터 저장소와 결합되었을 때 **'정확히 한 번'** 까지도 보장이 가능하다.

카프카 커넥트 API 가 오프셋을 다룰 때 외부 시스템과의 통합을 지원하는 API 를 제공하기 때문에 '정확히 한 번' 전달을 보장하는 파이프라인을 구축하기 위한 커넥터를 
개발하는 것 역시 더 쉬워졌다.

---

## 1.3. 높으면서도 조정 가능한 처리율

---

## 1.4. 데이터 형식

---

## 1.5. 변환

---

## 1.6. 보안

---

## 1.7. 장애 처리

---

## 1.8. 결합과 민첩성

---

# 2. 카프카 커넥트 vs 프로듀서/컨슈머

---

# 3. 카프카 커넥트

---

## 3.1. 카프카 커넥트 실행

---

## 3.2. 커넥터 예시: 파일 소스와 파일 싱크

---

## 3.3. 커넥터 예시: MySQL에서 Elasticsearch 로 데이터 전송

---

## 3.4. 개별 메시지 변환

---

## 3.5. 카프카 커넥트 좀 더 자세히

---

# 4. 카프카 커넥트 대안

---

## 4.1. 다른 데이터 저장소를 위한 수집 프레임워크

---

## 4.2. GUI 기반 ETL 툴

---

## 4.3. 스트림 프로세싱 프레임워크



---

# 참고 사이트 & 함께 보면 좋은 사이트

*본 포스트는 김병부 저자의 **O'REILLY 카프카 핵심 가이드 2판**를 기반으로 스터디하며 정리한 내용들입니다.*

* [카프카 핵심 가이드](https://www.yes24.com/Product/Goods/118397432)
* [예제 코드 & 오탈자](https://dongjinleekr.github.io/kafka-the-definitive-guide-v2/)
* [Doc:: Kafka](https://kafka.apache.org/documentation/)
* [Git:: Kafka](https://github.com/apache/kafka/)
* 